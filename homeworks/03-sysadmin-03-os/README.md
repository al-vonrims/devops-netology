# devops-netology

## Домашнее задание к занятию "3.3. Операционные системы, лекция 1"

#### 1. Какой системный вызов делает команда `cd`? В прошлом ДЗ мы выяснили, что `cd` не является самостоятельной  программой, это `shell builtin`, поэтому запустить `strace` непосредственно на `cd` не получится. Тем не менее, вы можете запустить `strace` на `/bin/bash -c 'cd /tmp'`. В этом случае вы увидите полный список системных вызовов, которые делает сам `bash` при старте. Вам нужно найти тот единственный, который относится именно к `cd`. Обратите внимание, что `strace` выдаёт результат своей работы в поток stderr, а не в stdout.
Системный вызов: `chdir("/tmp")`

#### 2. Попробуйте использовать команду `file` на объекты разных типов на файловой системе. Используя `strace` выясните, где находится база данных `file` на основании которой она делает свои догадки.
База данных находится в файле `/usr/share/misc/magic.mgc`.  Но может находиться и в `/etc/magic.mgc`.  
Пользователь может задавать свои шаблоны в `/etc/magic` для идентификации файлов. 

```bash
openat(AT_FDCWD, "/etc/magic.mgc", O_RDONLY) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/etc/magic", O_RDONLY) = 3
openat(AT_FDCWD, "/usr/share/misc/magic.mgc", O_RDONLY) = 3
```

#### 3. Предположим, приложение пишет лог в текстовый файл. Этот файл оказался удален (deleted в lsof), однако возможности сигналом сказать приложению переоткрыть файлы или просто перезапустить приложение – нет. Так как приложение продолжает писать в удаленный файл, место на диске постепенно заканчивается. Основываясь на знаниях о перенаправлении потоков предложите способ обнуления открытого удаленного файла (чтобы освободить место на файловой системе).
* Найдем дескриптор для удалённого файла командой `ls -l /proc/<pid>/fd`, где `<pid>` идентификатор процесса. 
```bash
root@vagrant:/tmp# ls -l /proc/2549/fd
total 0
lrwx------ 1 root root 64 Jan 11 14:29 0 -> /dev/pts/1
l-wx------ 1 root root 64 Jan 11 14:29 1 -> '/tmp/test.txt (deleted)'
lrwx------ 1 root root 64 Jan 11 14:29 2 -> /dev/pts/1
```
* Выполним очистку: `> /proc/2549/fd/1`

#### 4. Занимают ли зомби-процессы какие-то ресурсы в ОС (CPU, RAM, IO)?
Нет, не считая память необходимую для хранения информации о процессе в таблице процессов ядра.

#### 5. В iovisor BCC есть утилита `opensnoop`/. На какие файлы вы увидели вызовы группы `open` за первую секунду работы утилиты? Воспользуйтесь пакетом `bpfcc-tools` для Ubuntu 20.04. Дополнительные [сведения по установке](https://github.com/iovisor/bcc/blob/master/INSTALL.md).
Вызовы на следующие файлы:
```bash
/var/run/utmp
/usr/local/share/dbus-1/system-services
/usr/share/dbus-1/system-services
/lib/dbus-1/system-services
/var/lib/snapd/dbus-1/system-services/
```
#### 6. Какой системный вызов использует `uname -a`? Приведите цитату из man по этому системному вызову, где описывается альтернативное местоположение в `/proc`, где можно узнать версию ядра и релиз ОС.
Использует системный вызов `uname`  
`Part of the utsname information is also accessible via /proc/sys/kernel/{ostype, hostname, osrelease, version, domainname}`

#### 7. Чем отличается последовательность команд через `;` и через `&&` в bash? Есть ли смысл использовать в bash `&&`, если применить `set -e`?
Команды, разделенные `;` выполняются последовательно. Оболочка ожидает завершения каждой команды по очереди.
Команда после `&&` выполняется только, если статус выхода из команды до `&&` равен нулю (успешное завершение).
Смысла использовать `set -e` - нет, т.к. при возврате ненулевого статуса произойдет завершение скрипта.

#### 8. Из каких опций состоит режим bash `set -euxo pipefail` и почему его хорошо было бы использовать в сценариях?
Состоит из следующих опций:  
`-e` - Немедленно завершать, если простая команда завершает работу с ненулевым статусом выхода.  
`-u` - При подстановке значений параметров рассматривать не установленную переменную как ошибку.  
`-x` - Выводит команды и их аргументы по мере выполнения.  
`-o pipefail` - возвращаемое значение pipeline — это значение последней (самой правой) команды с ненулевым статусом выхода или ноль, если все команды завершаются успешно.

С данными опциями проще проверить код сценария на корректность. Упрощается диагностирование в случаях некорректной работы и возникновения ошибок.  

#### 9. Используя `-o stat` для `ps`, определите, какой наиболее часто встречающийся статус у процессов в системе. В `man ps` ознакомьтесь (`/PROCESS STATE CODES`) что значат дополнительные к основной заглавной буквы статуса процессов. Его можно не учитывать при расчете (считать S, Ss или Ssl равнозначными).
Наиболее часто встречающийся статус у процессов - `S`  
`S` - interruptible sleep (waiting for an event to complete)

Дополнительные статусы:  
`<` - high-priority (not nice to other users)  
`N` - low-priority (nice to other users)  
`L` - has pages locked into memory (for real-time and custom IO)  
`s` - is a session leader  
`l` - is multi-threaded (using CLONE_THREAD, like NPTL pthreads do)  
`+` - is in the foreground process group